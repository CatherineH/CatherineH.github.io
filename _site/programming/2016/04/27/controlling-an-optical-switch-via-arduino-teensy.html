
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Controlling an Optical Switch via Arduino (Teensy)</title>
    <meta name="description" content="">
    <meta name="author" content="Catherine Holloway">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="http://CatherineH.github.io/assets/themes/bootstrap-3/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="http://CatherineH.github.io/assets/themes/bootstrap-3/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="http://CatherineH.github.io/assets/themes/bootstrap-3/bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="http://CatherineH.github.io/assets/themes/bootstrap-3/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="http://CatherineH.github.io/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="http://CatherineH.github.io/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Catherine's Auxiliary Brain</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse">
          <ul class="nav navbar-nav">
            
            
            


  
    
      
    
  
    
      
      	
      	<li><a href="http://CatherineH.github.io/archive">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="http://CatherineH.github.io/categories">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="http://CatherineH.github.io/pages">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="http://CatherineH.github.io/tags">Tags</a></li>
      	
      
    
  



          </ul>
          <form class="navbar-form navbar-right" role="search">
            <div class="form-group">
              <input type="text" class="form-control" placeholder="Search">
            </div>
            <button type="submit" class="btn btn-default">Submit</button>
          </form>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div class="container">
        
<div class="page-header">
  <h1>Controlling an Optical Switch via Arduino (Teensy) </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>27 April 2016</span>
    </div>
    <div class="content">
      
<p>Aside from fingerprints, there is nothing more annoying, or more damaging to optics equipment than unplugging and
plugging in fiber optics. Every time a fiber tip or port is exposed to air, there’s a chance of getting gross human skin
 cells on places where tightly focused high-power light might incinerate them, yet, so many experiments require routing
 light. Wouldn’t it be nicer if a robot did the switching for you at 2 am while your gross dust and sweat producing body
  is sleeping?</p>

<p>In experiments, I accomplish this using a teensy LC and a DiCon optical switch.</p>

<h1 id="electonics-side">Electonics Side</h1>

<p>The optical switch I use is a <a href="http://www.diconfiberoptics.com/products/scd0009/scd0009f.pdf">DiCon 2x2 prism switch</a>,
which is essentially a little piece of glass on a motor.</p>

<p><img src="https://raw.githubusercontent.com/CatherineH/CatherineH.github.io/master/_posts/images/dicon_switch.jpg" alt="A picture of a DiCon fiber optic switch" /></p>

<p>This switch will operate in several modes, but in every mode the first two (blue and purple) pins are used to set the
position and the second two (red and green) pins are used to read the position of the switch.</p>

<p>I chose to operate the switch in <em>Non-latching 2-pin Control</em> mode, because it was the least complicated.</p>

<p>I chose to put the two pins that should never change in control mode (purple should always be ground, red should always
be +5V) and the two pins with changing values (blue and green) on the other. This led to a lot of initial confusion, but
 I believe it was a good decision to because it allows me to keep the two pins that need to be hooked up to some external logic together.</p>

<p><img src="https://raw.githubusercontent.com/CatherineH/CatherineH.github.io/master/_posts/images/teensy_switch.jpg" alt="A picture of the headers going into the teensy" /></p>

<p>The threshold voltage for switching is above 3.3V, which is the maximum that the Teensy’s output pins can supply. Thus,
I chose to use a solid state relay to bump the signal up to 5V. I use Sharp Microelectronics
<a href="http://www.digikey.com/product-detail/en/sharp-microelectronics/PR22MA11NTZF/425-2602-5-ND/856883">R22MA1</a> because
they’re super cheap (25.65$ for 50) and I have a tendency to accidentally blow electronics up.</p>

<p>My prototype board looks like this:</p>

<p><img src="https://raw.githubusercontent.com/CatherineH/CatherineH.github.io/master/_posts/images/switch_bb.png" alt="Fritzing image of breadboard" /></p>

<p>Imagine the Sharp SSR on the breadboard instead of the Omron SSR. You’ll notice that I have left the green pin
unconnected. The switch has always activated when 5V, thus the position information isn’t useful right now.</p>

<h1 id="arduino-code">Arduino Code</h1>

<p>This teensy is also used to control several other pieces of experimental hardware, so I’ve excerpted it here.</p>

<p>I want to be able to read the current position state and write a new position state using a SCPI-compliant serial
connection.</p>

<p>My .ino code looks like this:</p>

<pre><code>#include "scpi_comm.h"
#include "optical_switch.h"
int switch_led_pin = 13;
int out_pin = 9;
settings _settings = {.switch_setting = 1, .motor = _state};

void setup()
{
  Serial.begin(9600);
  pinMode(switch_led_pin, OUTPUT);
  pinMode(out_pin, OUTPUT);
}

void loop()
{
  update_optical_switch(_settings.switch_setting, out_pin, switch_led_pin);
  if (Serial.available() &gt; 0) {
    comm_protocol(Serial.read(), &amp;_settings);
  }
}
</code></pre>

<p>My <em>scpi_comm.h</em> contains an internal state machine which collects characters into a string until the termination
character is received, then attempts to parse the string:</p>

<pre><code>typedef struct {
  int switch_setting;
} settings;

char terminationByte = '\r';
int incomingByte = 0;
int string_pos = 0;
int current_state = 1;
char line[15];
char serialsecond[5];
char input_str[8];
char output_str[8];

void comm_protocol(byte incomingByte, settings *settings){
   line[string_pos] = incomingByte;
   string_pos += 1;
   if(incomingByte == terminationByte)
   {
     if(strncmp(line, ":OUTP", 5)==0)
     {
         char * loc = strchr(line, ':');
          loc = strchr(loc+1, ' ');
          memcpy(serialsecond, loc+1, 3);
          if(strncmp(serialsecond, "1", 1) == 0)
          {
             settings-&gt;switch_setting = 1;
          }
          else
          {
            settings-&gt;switch_setting = 0;
          }
          sprintf(output_str, "Set Switch to %d%c", settings-&gt;switch_setting, terminationByte);
          Serial.write(output_str);
     }
     else if(strncmp(line, "OUTP", 4)==0 &amp;&amp; strpbrk(line, "?") != 0)
     {
         sprintf(output_str, "%d%c",  settings-&gt;switch_setting, terminationByte);
         Serial.write(output_str);
     }
     else{
        sprintf(output_str, "Unknown command%c", terminationByte);
        Serial.write(output_str);
     }
     // reset the string
     string_pos = 0;
     line[0] = '\0';
   }
}
</code></pre>

<p>Lastly, my <em>optical_switch.h</em> code simply reads the settings and makes the Teensy’s indicator LED also go high when the
switch position is high:</p>

<pre><code>void update_optical_switch(int optical_state, int switch_pin, int led_pin)
{
  if(optical_state==1)
  {
    digitalWrite(switch_pin, HIGH);
    digitalWrite(led_pin, HIGH);
  }
  else
  {
    digitalWrite(switch_pin, LOW);
    digitalWrite(led_pin, LOW);
  }
}
</code></pre>

<h1 id="python-computer-side">Python (Computer) Side</h1>

<p>I used the fantastic <a href="https://github.com/Galvant/InstrumentKit">InstrumentKit</a> to incorporate the control into my
experimental software:</p>

<pre><code>#!/usr/bin/env python
from instruments.abstract_instruments import Instrument
from time import sleep
from sys import platform

class Switch(Instrument):
    """
    An interface to the teensy-controlled optical switch
    """
    def __init__(self, filelike, increment=200):
        super(Switch, self).__init__(filelike)
        self.terminator = "\r"
        self.increment = increment

    @property
    def setting(self):
        """
        Get the current output setting
        :return: int, representing the currently active channel
        """
        response = self.query("OUTP?")
        return int(response)

    @setting.setter
    def setting(self, new_val):
        """
        Set the current output setting
        :param new_val: the output channel number, either 0 or 1
        :return:
        """
        if new_val == 0:
            response = self.query(":OUTP 0")
        elif new_val == 1:
            response = self.query(":OUTP 1")

def main():
   # Runs the switch program on its own, as a test
    if platform == "linux" or platform == "linux2":
        port = "/dev/ttyACM0"
    else:
        port = "COM11"
    switch = Switch.open_serial(port, 9600, timeout=1)
    print("switch tests")

    iteration = 0
    for i in range(0, 50):
        print("Iteration: "+str(iteration))
        iteration += 1
        switch.setting = 0
        sleep(2)
        switch.setting = 1
        sleep(2)

if __name__ == "__main__":
    main()
</code></pre>

<p>While the coding side of this application may seem a bit over-engineered, it is because I want to apply the
<a href="https://en.wikipedia.org/wiki/Principle_of_least_astonishment">principle of least astonishment</a> to everything I do; by
labeling everything I don’t have to guess at some convention I decided on several months ago. This switch is a simple
piece of a much more complex testing organism, and I want it to be the least complicated organ.</p>

    </div>

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-open"></i></li>
      
      


  
     
    	<li><a href="http://CatherineH.github.io/categories.html#programming-ref">
    		programming <span>9</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-tags"></i></li>
      
      


  
     
    	<li><a href="http://CatherineH.github.io/tags.html#electronics-ref">electronics <span>1</span></a></li>
     
    	<li><a href="http://CatherineH.github.io/tags.html#C-ref">C <span>2</span></a></li>
     
    	<li><a href="http://CatherineH.github.io/tags.html#python-ref">python <span>6</span></a></li>
     
    	<li><a href="http://CatherineH.github.io/tags.html#InstrumentKit-ref">InstrumentKit <span>1</span></a></li>
    
  



    </ul>
    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="http://CatherineH.github.io/programming/2016/04/25/walking-through-frustration" title="Walking Through Mars and Frustration">&laquo; Previous</a></li>
    
      <li><a href="http://CatherineH.github.io/archive.html">Archive</a></li>
    
      <li class="next"><a href="http://CatherineH.github.io/music/2016/04/29/stuff-i-bought-on-bandcamp-in-april" title="Stuff I bought on Bandcamp in April">Next &raquo;</a></li>
    
    </ul>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_developer = 1;
    var disqus_shortname = 'catherineh'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>

    </div>

    <div id="footer">
      <div class="container">
        <p>&copy; 2016 Catherine Holloway
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
        </p>
      </div>
    </div>

    





    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://CatherineH.github.io/assets/themes/bootstrap-3/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>


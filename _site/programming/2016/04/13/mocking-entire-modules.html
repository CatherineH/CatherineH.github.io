
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <title>Mocking Entire Modules</title>
    <meta name="description" content="or Mock-ception">
    <meta name="author" content="Catherine Holloway">

    <!-- Enable responsive viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bootstrap styles -->
    <link href="http://CatherineH.github.io/assets/themes/bootstrap-3/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <!-- Optional theme -->
    <link href="http://CatherineH.github.io/assets/themes/bootstrap-3/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet">
    <!-- Sticky Footer -->
    <link href="http://CatherineH.github.io/assets/themes/bootstrap-3/bootstrap/css/bs-sticky-footer.css" rel="stylesheet">
    
    <!-- Custom styles -->
    <link href="http://CatherineH.github.io/assets/themes/bootstrap-3/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->

    <!-- atom & rss feed -->
    <link href="http://CatherineH.github.io/atom.xml" type="application/atom+xml" rel="alternate" title="Sitewide ATOM Feed">
    <link href="http://CatherineH.github.io/rss.xml" type="application/rss+xml" rel="alternate" title="Sitewide RSS Feed">

  </head>

  <body>
    <div id="wrap">
      <nav class="navbar navbar-default" role="navigation">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#jb-navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">Catherine's Auxiliary Brain</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="jb-navbar-collapse">
          <ul class="nav navbar-nav">
            
            
            


  
    
      
    
  
    
      
      	
      	<li><a href="http://CatherineH.github.io/archive">Archive</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="http://CatherineH.github.io/categories">Categories</a></li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="http://CatherineH.github.io/pages">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="http://CatherineH.github.io/tags">Tags</a></li>
      	
      
    
  



          </ul>
          <form class="navbar-form navbar-right" role="search">
            <div class="form-group">
              <input type="text" class="form-control" placeholder="Search">
            </div>
            <button type="submit" class="btn btn-default">Submit</button>
          </form>
        </div><!-- /.navbar-collapse -->
      </nav>

      <div class="container">
        
<div class="page-header">
  <h1>Mocking Entire Modules </h1>
</div>

<div class="row post-full">
  <div class="col-xs-12">
    <div class="date">
      <span>13 April 2016</span>
    </div>
    <div class="content">
      
<p>I’m increasing the code coverage on my <a href="https://github.com/CatherineH/pyglet_helper">pyglet_helper</a>
project prior to adding new functionality.
As of right now it is:</p>

<p><a href="https://coveralls.io/github/CatherineH/pyglet_helper?branch=master"><img src="https://coveralls.io/repos/github/CatherineH/pyglet_helper/badge.svg?branch=master" alt="Coverage Status" /></a></p>

<p>If this is green, I have succeeded in my task. Go me!</p>

<p>Before I got this spiffy number, I had to tackle an issue: pyglet_helper project is built on top of OpenGL, but OpenGL needs a display to draw to. The continuous integration system I am using (Travis) does not
have a display.</p>

<p>After embarking on a fool’s errand to get <a href="http://xpra
.org/trac/wiki/Xdummy">Xdummy</a> working in a docker container, my friend <a href="http://scasagrande.github.io/">Steven</a> pointed to an easier solution: simply create
 a fakeGL module and then run the tests using that instead of OpenGL. This
 is not an ideal solution, as my unit tests will only check to make sure
 that the math is correct, and not that things are being drawn to the screen
  without glitching, but at the moment I’m okay with that. I’m not trying to
   test the functionality of OpenGL; I want to test that my math and the
   inheritance of the objects in pyglet_helper works out. My own math
   mistakes, and not OpenGL, are responsible for 99% of the weird visual
   glitches in pyglet_helper.</p>

<p>This post details how to replace an entire module in python unit tests,
since I didn’t find it in my initial reading of the mock documentation.</p>

<p>As an example, suppose we have some math to be tested on a 
Windows AMD machine<sup id="fnref:1"><a href="#fn:1" class="footnote">1</a></sup>. Thus, we would like to mock out numpy.</p>

<p>The function to be tested is in the file <strong>one_deep.py</strong>:</p>

<pre><code>import numpy

def sum_array(lower, upper):
    return sum(numpy.arange(lower, upper))
</code></pre>

<p>This module uses the arange function in numpy, so the file <strong>fake_numpy.py</strong>
 contains the code:</p>

<pre><code>def arange(lower, upper):
    return range(lower, upper)
</code></pre>

<p>Essentially, the range is now a list instead of a numpy array.</p>

<p>The unit test, which replaces <strong>numpy</strong> with <strong>fake_numpy</strong> is:</p>

<pre><code>from mock import patch
import fake_numpy


@patch('one_deep.numpy', new=fake_numpy)
def test_sum_to_hundred():
    from one_deep import sum_array
    result = sum_array(4, 16)
    assert result == 114
</code></pre>

<p>Now, suppose we need to go deeper. A second function is in the file
<strong>two_deep.py</strong>:</p>

<pre><code>from one_deep import sum_array
import numpy


def sum_array_again(lower, upper):
    return sum(numpy.arange(lower, sum_array(lower, upper)))
</code></pre>

<p>In our unit tests, if only <strong>two_deep</strong> is patched, when <strong>sum_array</strong> is
called, it will still use <strong>numpy.arange</strong> instead of <strong>fake_numpy.arange</strong>.
 This can produce some interesting errors if <strong>numpy</strong> is expecting to
 operate on <strong>numpy</strong> types.</p>

<p>Thus, the module must be patched all the way down:</p>

<pre><code>from mock import patch
import fake_numpy


@patch('one_deep.numpy', new=fake_numpy)
@patch('two_deep.numpy', new=fake_numpy)
def test_sum_to_hundred():
    from two_deep import sum_array_again
    result = sum_array_again(4, 16)
    assert result == 6435
</code></pre>

<p>Unfortunately, I haven’t figured out a good way of making sure that numpy
gets patched all in every place where it is invoked yet, leading to a lot of
 failed Travis builds as I encover another layer of a pyglet_helper object’s
  dependencies which rely on OpenGL.</p>

<div class="footnotes">
  <ol>
    <li id="fn:1">
      <p>Numpy does not support Windows running on AMD chips, as I recently learned. <a href="#fnref:1" class="reversefootnote">&#8617;</a></p>
    </li>
  </ol>
</div>

    </div>

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-open"></i></li>
      
      


  
     
    	<li><a href="http://CatherineH.github.io/categories.html#programming-ref">
    		programming <span>9</span>
    	</a></li>
    
  


    </ul>
    

  
    <ul class="tag_box inline">
      <li><i class="glyphicon glyphicon-tags"></i></li>
      
      


  
     
    	<li><a href="http://CatherineH.github.io/tags.html#python-ref">python <span>6</span></a></li>
     
    	<li><a href="http://CatherineH.github.io/tags.html#testing-ref">testing <span>1</span></a></li>
    
  



    </ul>
    
  
    <hr>
    <ul class="pagination">
    
      <li class="prev"><a href="http://CatherineH.github.io/music/2016/04/11/vikings-in-hungary" title="Vikings in Hungary">&laquo; Previous</a></li>
    
      <li><a href="http://CatherineH.github.io/archive.html">Archive</a></li>
    
      <li class="next"><a href="http://CatherineH.github.io/programming/2016/04/15/arduino-builder-errors" title="arduino builder errors">Next &raquo;</a></li>
    
    </ul>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    
    var disqus_developer = 1;
    var disqus_shortname = 'catherineh'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
</div>


      </div>

    </div>

    <div id="footer">
      <div class="container">
        <p>&copy; 2016 Catherine Holloway
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>
        </p>
      </div>
    </div>

    





    <!-- Latest compiled and minified JavaScript, requires jQuery 1.x (2.x not supported in IE8) -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="http://CatherineH.github.io/assets/themes/bootstrap-3/bootstrap/js/bootstrap.min.js"></script>
  </body>
</html>

